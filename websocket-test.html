<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.1.1/lib/stomp.min.js"></script>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <div id="status">Connecting...</div>
    <div id="messages"></div>

    <script>
        // Polyfill cho global
        if (typeof global === 'undefined') {
            window.global = window;
        }

        // Polyfill cho process
        if (typeof process === 'undefined') {
            window.process = { env: {} };
        }

        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');

        function addMessage(message) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            messagesDiv.appendChild(div);
        }

        try {
            // Tạo SockJS connection
            const socket = new SockJS('http://localhost:8080/ws');
            
            // Tạo STOMP client
            const stompClient = new StompJs.Client({
                webSocketFactory: () => socket,
                debug: function (str) {
                    console.log('STOMP Debug:', str);
                },
                reconnectDelay: 5000,
                heartbeatIncoming: 4000,
                heartbeatOutgoing: 4000
            });

            stompClient.onConnect = (frame) => {
                statusDiv.textContent = 'Connected to WebSocket!';
                statusDiv.style.color = 'green';
                addMessage('Connected to WebSocket server');
                addMessage('Session ID: ' + frame.headers['user-name']);

                // Subscribe to booking updates
                stompClient.subscribe('/topic/booking-updates', (message) => {
                    const body = JSON.parse(message.body);
                    addMessage('Received booking update: ' + JSON.stringify(body));
                });

                // Subscribe to specific booking
                stompClient.subscribe('/topic/booking-updates/1', (message) => {
                    const body = JSON.parse(message.body);
                    addMessage('Received specific booking update: ' + JSON.stringify(body));
                });
            };

            stompClient.onStompError = (frame) => {
                statusDiv.textContent = 'STOMP Error: ' + frame.headers['message'];
                statusDiv.style.color = 'red';
                addMessage('STOMP Error: ' + frame.headers['message']);
            };

            stompClient.onWebSocketError = (error) => {
                statusDiv.textContent = 'WebSocket Error: ' + error;
                statusDiv.style.color = 'red';
                addMessage('WebSocket Error: ' + error);
            };

            stompClient.onDisconnect = () => {
                statusDiv.textContent = 'Disconnected from WebSocket';
                statusDiv.style.color = 'orange';
                addMessage('Disconnected from WebSocket');
            };

            // Activate connection
            stompClient.activate();
            addMessage('Attempting to connect...');

        } catch (error) {
            statusDiv.textContent = 'Error: ' + error.message;
            statusDiv.style.color = 'red';
            addMessage('Error: ' + error.message);
        }
    </script>
</body>
</html> 